<!doctype html>
<html>

<head>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.13/vue.min.js"></script>
	<script src="../js/tinymce/js/tinymce/jquery.tinymce.min.js"></script>
	<script src="../js/tinymce/js/tinymce/vue/tinymce-vue.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.min.js"></script>

	<script src="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.js"></script>
	<link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.css" />

	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css">
	<link rel="stylesheet" href="../js/tinymce/js/tinymce/themes/modern/theme.min.js">

	<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>

	<style>
		.control-child {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		#editmodal hr {
			border-color: black;
		}

		body {
			/*padding: 10px;*/
			padding-top: 10px;
			padding-bottom: 10px;
		}

		.btnpreview {
			width: 100%;
			height: 150px;
			background-size: contain;
			background-repeat: no-repeat;
			background-position: center;
			transition: 0.5s background;
		}

		.fbpreview {
			width: 100%;
			padding-top: 50%;
			background-size: cover;
			background-repeat: no-repeat;
			background-position: center;
		}

		.artworkpreview {
			width: 100%;
			height: 100%;
			margin-top: 10px;
			margin-bottom: 10px;
		}

		.mce-notification-warning {
			display: none;
		}

		.form-control-inline {
			display: inline;
			width: 200px;
		}

		.select2-dropdown {
			background-color: cornsilk;
		}

		.picrow-con .form-group {
			padding: 10px;
			border: 1px solid black;
		}
	</style>
</head>

<body>
	<div id="firebaseui-auth-container"></div>
	<div id="vue-wrap" class="container-fluid" v-if="auth_email">
		<div id="user-inf" class="d-flex justify-content-between">
			<div>
				<b>Login :</b> <span id="email">{{auth_email}}</span> <i v-if="isadmin">(Member)</i>
			</div>
			<button class="btn btn-danger" onclick="
					firebase.auth().signOut().then(function(){
						window.location.reload();
					}).catch(function(err){
						alert('Logout error '+JSON.stringify(err));
						console.log('Logout error', err);
					});">Logout</button>
		</div>

		<button class="btn btn-success" onclick="doadd();">Add</button>
		<div class="dropdown d-inline-block mb-3">
			<button class="btn btn-primary dropdown-toggle" type="button" id="sortbybtn" data-toggle="dropdown" aria-haspopup="true"
			 aria-expanded="false">
				Sort by
			</button>
			<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
				<a class="dropdown-item" :href="updateQueryStringParameter('sortby','created')">วันที่สร้าง</a>
				<a class="dropdown-item" :href="updateQueryStringParameter('sortby','due')">กำหนดส่งงาน</a>
				<a class="dropdown-item" :href="updateQueryStringParameter('sortby','id')">ID</a>
			</div>
		</div>

		<h1 v-if="loading">Loading</h1>

		<div id="control-wrap">
			<div v-for="(quotdata_currmonth,month) in quotdata_bymonth" :id="'quotdata_group_wrap_'+quotdata_currmonth.i" class="accordion">
				<div class="card mb-3 border-primary rounded" style="border-width: 2px; border-bottom: solid 2px;">
					<button class="btn btn-block btn-primary" :id="'quotdata_group_heading_'+quotdata_currmonth.i" data-toggle="collapse" :data-target="'#quotdata_group_'+quotdata_currmonth.i"
					 :aria-expanded="quotdata_currmonth.i==0?'true':'false'" :aria-controls="'quotdata_group_'+quotdata_currmonth.i">
						<h3>{{month}}</h3>
					</button>

					<div :id="'quotdata_group_'+quotdata_currmonth.i" :class="['collapse',quotdata_currmonth.i==0?'show':'collapse']" :aria-labelledby="'quotdata_group_heading_'+quotdata_currmonth.i"
					 :data-parent="'#quotdata_group_wrap_'+quotdata_currmonth.i">
						<div class="card-body">
							<ul class="list-group">
								<li class="control-child list-group-item" v-for="val in quotdata_currmonth">
									<div>
										<b>ID:</b> {{val.id}}
										<br>
										<b>กำหนดส่งงาน:</b> {{formatdate(val.due)}}
										<br>
										<b>วันที่สร้าง:</b> {{formatdate(val.created)}}
										<br>
										<b>ชื่อ:</b> {{val.name}}
										<br>
									</div>
									<div>
										<!--<button class="btn btn-success" v-on:click="countamount(val); console.log(val.amountlist);">ดูจำนวน</button>-->
										<button :class="['btn',(val.approve?'btn-success':'btn-secondary')]" v-on:click="doapprove(val.i)">{{val.approve?'อนุมัติ':'รอการอนุมัติ'}}</button>
										<button class="btn btn-primary" v-on:click="docountamount(val.i)">ใบตรวจนับ</button>
										<button class="btn btn-success" v-on:click="doshow(val.i)">แสดง</button>
										<button class="btn btn-primary" v-on:click="doedit(val.i)">แก้ไข</button>
										<button class="btn btn-warning" v-on:click="doduplicate(val.i)">ทำซ้ำ</button>
										<button class="btn btn-danger" v-on:click="dodelete2(val.i)">ลบ</button>
									</div>
								</li>
							</ul>
							<div>
								<i>จำนวน : {{quotdata_currmonth.length}} ใบเสนอราคา</i>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--<div>
				<i>จำนวน : {{quotdata_length}} ใบเสนอราคา</i>
			</div>-->
		</div>
	</div>

	<div id="vue-countmodal">
		<div class="modal fade" id="countmodal" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="countmodal_title">สร้างใบตรวจนับ {{quotdata[vm_edit.curr].id}}</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<button type="button" class="btn btn-primary"
							v-on:click="countamount(quotdata[vm_edit.curr]); vm_count.isSaved = false; vm_count.$forceUpdate();">
							ดึงข้อมูลจาก {{quotdata[vm_edit.curr].id}} (แทนที่ข้อมูลเดิม)
						</button>
						<hr>
						<div class="d-flex flex-column justify-content-center">
							<div class="row mb-2 justify-content-center" v-for="(val, key) in quotdata[vm_edit.curr].amountlist" :style='{
								"order": val.order
							}'>
								<div class="col-6 pr-0">
									<input type="text" :value="key" class="form-control" :oldval="key" onchange="
										var old = $(this).attr('oldval');
										var curr = $(this).val();
										if (!quotdata[vm_edit.curr].amountlist[curr]) {
											quotdata[vm_edit.curr].amountlist[curr] = quotdata[vm_edit.curr].amountlist[old];
										} else {
											if (!isNaN(Number(quotdata[vm_edit.curr].amountlist[curr].amount)) && !isNaN(Number(quotdata[vm_edit.curr].amountlist[old].amount))) {
												quotdata[vm_edit.curr].amountlist[curr].amount = Number(quotdata[vm_edit.curr].amountlist[curr].amount) + Number(quotdata[vm_edit.curr].amountlist[old].amount);
											} else {
												quotdata[vm_edit.curr].amountlist[curr].amount = quotdata[vm_edit.curr].amountlist[curr].amount + quotdata[vm_edit.curr].amountlist[old].amount;
											}
											quotdata[vm_edit.curr].amountlist[curr].order = quotdata[vm_edit.curr].amountlist[old].order;
										}
										delete quotdata[vm_edit.curr].amountlist[old];
										vm_count.isSaved = false;
										vm_count.$forceUpdate();
									">
								</div>
								<div class="col-3">
									<input type="text" :value="val.amount" class="form-control" v-model="quotdata[vm_edit.curr].amountlist[key].amount" onchange="vm_count.isSaved = false;">
								</div>
								<div class="col-3 p-0">
									<button class="btn btn-warning" v-on:click="
										var sib = _.findKey(quotdata[vm_edit.curr].amountlist,{order:quotdata[vm_edit.curr].amountlist[key].order-1});
										if (sib) {
											quotdata[vm_edit.curr].amountlist[sib].order = quotdata[vm_edit.curr].amountlist[key].order;
											quotdata[vm_edit.curr].amountlist[key].order = quotdata[vm_edit.curr].amountlist[key].order-1;
										}
										vm_count.isSaved = false;
										vm_count.$forceUpdate()
									">^</button>

									<button class="btn btn-warning" v-on:click="
										var sib = _.findKey(quotdata[vm_edit.curr].amountlist,{order:quotdata[vm_edit.curr].amountlist[key].order+1});
										if (sib) {
											quotdata[vm_edit.curr].amountlist[sib].order = quotdata[vm_edit.curr].amountlist[key].order;
											quotdata[vm_edit.curr].amountlist[key].order = quotdata[vm_edit.curr].amountlist[key].order+1;
										}
										vm_count.isSaved = false;
										vm_count.$forceUpdate()
									">v</button>

									<button class="btn btn-danger" v-on:click="
										delete quotdata[vm_edit.curr].amountlist[key];

										//Reorder (Coor compression)
										var coor = [];
										for(var _ in quotdata[vm_edit.curr].amountlist) {
											coor.push(quotdata[vm_edit.curr].amountlist[_].order)
										}
										coor.sort();
										var coorres = {};
										for(var i = 0;i<coor.length;i++) {
											coorres[coor[i]] = i; 
										}
										for(var _ in quotdata[vm_edit.curr].amountlist) {
											quotdata[vm_edit.curr].amountlist[_].order = coorres[quotdata[vm_edit.curr].amountlist[_].order];
										}

										vm_count.isSaved = false;
										vm_count.$forceUpdate();
									">X</button>
								</div>
							</div>
						</div>
						<button class="btn btn-primary" v-on:click="
							quotdata[vm_edit.curr].amountlist[Math.random().toString(16).substr(2)] = {
								amount: 0,
								order: _.keys(quotdata[vm_edit.curr].amountlist).length
							};
							vm_count.$forceUpdate();
						">เพิ่มขนาด</button>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-success" v-on:click="(async function() { await edit_submit(); isSaved=true;})()" v-if="!isSaved">Save</button>
						<button type="button" class="btn btn-primary" onclick="window.open('/quotation/viewamount?id=' + encodeURIComponent(quotdata[vm_edit.curr].id), '_blank');" v-if="isSaved">View</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="vue-editmodal">
		<div class="modal" tabindex="-1" role="dialog" id="editmodal" data-backdrop="static">
			<div class="modal-dialog modal-lg" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">{{quotdata[curr].id}}</h5>
						<!--<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>-->
						<button type="button" class="btn btn-secondary edit-footer-btn" data-dismiss="modal" onclick="edit_exit()">ปิด (ไม่เปลี่ยนข้อมูลกลับ)</button>
					</div>
					<div class="modal-body" style="background-color:rgb(217,217,217);">
						<div class="form-group">
							โปรเจค
							<input type="text" class="form-control" id="edit-topic" v-model="quotdata[curr].name">
						</div>

						<div class="picrow-con" id="edit-img" v-if="quotdata[curr].img && typeof quotdata[curr].img == 'object'">
							<div class="form-group" v-for="(picrow,i) in quotdata[curr].img">
								<div style="display:flex">
									<div style="text-align:center; flex-basis:100%;">
										<img class="picrowpreview" :src="picrow.img" :style="{width:picrow.imgsize+'%'}">
									</div>
								</div>
								ไฟล์ภาพ
								<input type="file" class="form-control" :id="'edit-img-'+i" accept="image/*"> ขนาดรูป (%)
								<input type="number" class="form-control" :id="'edit-img-size-'+i" v-model="picrow.imgsize" v-on:change="vm_edit.$forceUpdate()">
								<button class="btn btn-danger" @click="quotdata[curr].img.splice(i,1); vm_edit.$forceUpdate();">ลบ</button>
							</div>
						</div>
						<button class="btn btn-success" @click="
								if (quotdata[curr].img) { quotdata[curr].img.push({img:'',imgsize:50}); vm_edit.$forceUpdate(); }
								else { alert('กดปุ่ม บันทึก ด้านล่างเพื่ออัพเดทข้อมูลเป็น version ล่าสุดก่อน ถึงจะใช้งานได้'); }
							" v-if="quotdata[curr].img && typeof quotdata[curr].img == 'object'">เพิ่มรูปภาพด้านบน</button>
						
						<div class="form-group" v-if="typeof quotdata[curr].img == 'string'">
							รูปอาร์ทเวิร์ค
							<div style="text-align:center; width:100%;">
								<img class="artworkpreview" :src="quotdata[curr].img" :style="{width:quotdata[curr].imgsize+'%'}">
							</div>
							<input type="file" class="form-control" :id="'edit-awimg'" accept="image/*">
						</div>
						<div class="form-group" v-if="typeof quotdata[curr].img == 'string'">
							ขนาดรูปอาร์ทเวิร์ค (%)
							<input type="number" class="form-control" id="edit-awimg-size" v-model="quotdata[curr].imgsize">
						</div>
						<div class="form-group">
							กำหนดส่งงาน
							<input type="date" class="form-control" id="edit-due" v-model="quotdata[curr].due">
						</div>
						<div class="form-group">
							ชนิดเสื้อ
							<select id="edit-type" class="form-control editor-select" onchange="quotdata[vm_edit.curr].type = event.target.value; refresh_select2(); setTimeout(()=>{refresh_select2()},100);"
							 :value="quotdata[curr].type">
								<option v-for="opt in selectdata['type']" :value="opt.value" v-if="eval(opt.condition)">{{opt.text}}</option>
								<option v-if="!selectdata_find('type',quotdata[curr].type)">{{quotdata[curr].type}}</option>
							</select>
						</div>

						<!--<div class="form-group">
							รหัสผ่าน
							<input type="text" class="form-control" id="edit-topic" v-model="quotdata[curr].password">
						</div>-->

						<hr>
						<!--
                                quotdata[curr].data[0] -> งานตัดและเย็บ
                                quotdata[curr].data[1] -> งานสกรีน
                                quotdata[curr].data[2] -> งานปัก
                            -->
						<div class="form-group">
							<input type="checkbox" id="edit-0-enable" v-model="quotdata[curr].data[0].enable" onchange="refresh_select2()"> งานตัดและเย็บ
						</div>
						<span id="edit-0-group" v-if="quotdata[curr].data[0].enable">
							<div class="form-group">
								ป้ายแสดงขนาดเสื้อ
								<select id="edit-0-size_label" class="form-control editor-select" onchange="quotdata[vm_edit.curr].data[0].size_label = event.target.value;"
								 :value="quotdata[curr].data[0].size_label">
									<option v-for="opt in selectdata['0-size_label']" :value="opt.value" v-if="eval(opt.condition)">{{opt.text}}</option>
									<option v-if="!selectdata_find('0-size_label',quotdata[curr].data[0].size_label)">{{quotdata[curr].data[0].size_label}}</option>
								</select>
							</div>
							<div class="form-group">
								ไซต์เสื้อ
								<textarea id="edit-0-size" class="form-control" v-model="quotdata[curr].data[0].size" style="height:250px;"></textarea>
							</div>
							<div class="form-group">
								แขนเสื้อ
								<select id="edit-0-sleeve" class="form-control" onchange="quotdata[vm_edit.curr].data[0].sleeve = event.target.value;" :value="quotdata[curr].data[0].sleeve">
									<option>แขนสั้นปล่อย</option>
									<option>แขนสั้นจั้มแขน</option>
									<option>แขนสั้นเบิ้ล</option>
									<option>แขนยาวปล่อย</option>
									<option>แขนยาวจั้มแขน</option>
									<option>กุ๋นแขน</option>
									<option>จั้มครึ่ง</option>
									<option>{{quotdata[curr].data[0].sleeve}}</option>
								</select>
							</div>
							<div class="form-group">
								ลักษณะการเย็บ
								<select id="edit-0-style" class="form-control" onchange="quotdata[vm_edit.curr].data[0].style = event.target.value;" :value="quotdata[curr].data[0].style">
									<option>ตามรูปแบบมาตรฐาน</option>
									<option>คิ้วแขน</option>
									<option>{{quotdata[curr].data[0].style}}</option>
								</select>
							</div>
							<div class="form-group">
								สีเสื้อ
								<input type="text" id="edit-0-color" class="form-control" v-model="quotdata[curr].data[0].color">
							</div>
							<div class="form-group">
								คอเสื้อ
								<select id="edit-0-collar" class="form-control editor-select" onchange="quotdata[vm_edit.curr].data[0].collar = event.target.value;" :value="quotdata[curr].data[0].collar">
									<option v-for="opt in selectdata['0-collar']" :value="opt.value" v-if="eval(opt.condition)">{{opt.text}}</option>
									<option v-if="!selectdata_find('0-collar',quotdata[curr].data[0].collar)">{{quotdata[curr].data[0].collar}}</option>
								</select>
							</div>
							<div class="form-group">
								เนื้อผ้า
								<select id="edit-0-fabric" class="form-control editor-select" onchange="quotdata[vm_edit.curr].data[0].fabric = event.target.value;"
								 :value="quotdata[curr].data[0].fabric">
									<option v-for="opt in selectdata['0-fabric']" :value="opt.value" v-if="eval(opt.condition)">{{opt.text}}</option>
									<!--<option>Cotton 100%</option>
									<option>cotton comb</option>
									<option>TK</option>-->
									<option v-if="!selectdata_find('0-fabric',quotdata[curr].data[0].fabric)">{{quotdata[curr].data[0].fabric}}</option>
								</select>
							</div>
							<div class="form-group">
								ขึ้นตัวอย่าง
								<select id="edit-0-example" class="form-control" onchange="quotdata[vm_edit.curr].data[0].example = event.target.value;"
								 :value="quotdata[curr].data[0].example">
									<option>ขึ้นตัวอย่าง</option>
									<option>-</option>
									<option>{{quotdata[curr].data[0].example}}</option>
								</select>
							</div>
							<div class="form-group" v-if="quotdata[curr].type.indexOf('เสื้อโปโล')!=-1">
								สาบเสื้อ
								<select id="edit-0-placket" class="form-control editor-select" onchange="quotdata[vm_edit.curr].data[0].placket = event.target.value;"
								 :value="quotdata[curr].data[0].placket">
									<option v-for="opt in selectdata['0-placket']" :value="opt.value" v-if="eval(opt.condition)">{{opt.text}}</option>
									<option v-if="!selectdata_find('0-placket',quotdata[curr].data[0].placket)">{{quotdata[curr].data[0].placket}}</option>
								</select>
							</div>
							<div class="form-group" v-if="quotdata[curr].type.indexOf('เสื้อโปโล')!=-1">
								กระเป๋าเสื้อ
								<select id="edit-0-pocket" class="form-control" onchange="quotdata[vm_edit.curr].data[0].pocket = event.target.value;" :value="quotdata[curr].data[0].pocket">
									<option>ไม่มี</option>
									<option>มี</option>
									<option>{{quotdata[curr].data[0].pocket}}</option>
								</select>
							</div>
							<div class="form-group" v-if="quotdata[curr].type.indexOf('เสื้อโปโล')!=-1">
								กระดุม
								<input type="number" id="edit-0-button" class="form-control form-control-inline" v-model="quotdata[curr].data[0].button"> เม็ด
							</div>
							<div class="form-group">
								ลักษณะเสื้อเพิ่มเติม
								<textarea id="edit-0-moreinfo" class="form-control" v-model="quotdata[curr].data[0].moreinfo"></textarea>
							</div>
							<div class="form-group">
								จำนวน
								<textarea id="edit-0-amount" class="form-control" v-model="quotdata[curr].data[0].amount" style="height:250px"></textarea>
							</div>
							<div class="picrow-con" id="edit-0-picrow" v-if="quotdata[curr].data[0].picrow">
								<div class="form-group" v-for="(picrow,i) in quotdata[curr].data[0].picrow">
									<div style="display:flex">
										<div style="text-align:center; flex-basis:50%;">
											<img class="picrowpreview" :src="picrow.img" :style="{width:picrow.imgsize+'%'}">
										</div>
										<textarea id="edit-0-picrow-text" class="form-control" v-model="picrow.text" style="flex-basis:50%;"></textarea>
									</div>
									ไฟล์ภาพ
									<input type="file" class="form-control" :id="'edit-0-picrow-img-'+i" accept="image/*"> ขนาดรูป (%)
									<input type="number" class="form-control" :id="'edit-0-picrow-size-'+i" v-model="picrow.imgsize" v-on:change="vm_edit.$forceUpdate()">
									<button class="btn btn-danger" @click="quotdata[curr].data[0].picrow.splice(i,1); vm_edit.$forceUpdate();">ลบ</button>
								</div>
							</div>
							<button class="btn btn-success" @click="
									if (quotdata[curr].data[0].picrow) { quotdata[curr].data[0].picrow.push({img:'',text:'S = \nM = \nL = \nXL = \n',imgsize:75}); vm_edit.$forceUpdate() }
									else { alert('กดปุ่ม บันทึก ด้านล่างเพื่ออัพเดทข้อมูลเป็น version ล่าสุดก่อน ถึงจะใช้งานได้'); }
								">เพิ่มช่องรูปภาพ</button>
						</span>

						<hr>

						<div class="form-group">
							<input type="checkbox" id="edit-1-enable" v-model="quotdata[curr].data[1].enable" onchange="refresh_select2()"> งานสกรีน
						</div>
						<span id="edit-1-group" v-if="quotdata[curr].data[1].enable">
							<div class="form-group">
								ตำแหน่งสกรีน
								<input type="text" id="edit-1-position" class="form-control" v-model="quotdata[curr].data[1].position">
							</div>
							<div class="form-group">
								ขนาดสกรีน
								<input type="text" id="edit-1-size" class="form-control" v-model="quotdata[curr].data[1].size">
							</div>
							<div class="form-group">
								ระยะห่างจากคอเสื้อถึงตัวงาน
								<select id="edit-1-distance" class="form-control" onchange="quotdata[vm_edit.curr].data[1].distance = event.target.value;"
								 :value="quotdata[curr].data[1].distance">
									<option>ปรับตามขนาดเสื้อให้</option>
									<option>มาตรฐาน</option>
									<option value="custom_cm">... cm</option>
									<option>{{quotdata[curr].data[1].distance}}</option>
								</select>
								<template v-if="quotdata[vm_edit.curr].data[1].distance == 'custom_cm'">
									<input type="number" id="edit-1-distance-cm" class="form-control form-control-inline mt-2" v-model="quotdata[vm_edit.curr].data[1].distance_cm"> cm
								</template>
							</div>
							<div class="form-group">
								ชนิดงานสกรีน
								<select id="edit-1-type" class="form-control editor-select" onchange="quotdata[vm_edit.curr].data[1].type = event.target.value;" :value="quotdata[curr].data[1].type">
									<option v-for="opt in selectdata['1-type']" :value="opt.value" v-if="eval(opt.condition)">{{opt.text}}</option>
									<option v-if="!selectdata_find('1-type',quotdata[curr].data[1].type)">{{quotdata[curr].data[1].type}}</option>
								</select>
							</div>
							<div class="form-group">
								สีสกรีน
								<input type="text" id="edit-1-color" class="form-control" v-model="quotdata[curr].data[1].color">
							</div>
							<div class="form-group">
								ไฟล์เสื้อ
								<select id="edit-1-file" class="form-control" onchange="quotdata[vm_edit.curr].data[1].file = event.target.value;" :value="quotdata[curr].data[1].file">
									<option>อ้างอิงตามลูกค้า</option>
									<option>ดราฟใหม่</option>
									<option>{{quotdata[curr].data[1].file}}</option>
								</select>
							</div>
						</span>

						<hr>

						<div class="form-group">
							<input type="checkbox" id="edit-2-enable" v-model="quotdata[curr].data[2].enable" onchange="refresh_select2()"> งานปัก
						</div>
						<span id="edit-2-group" v-if="quotdata[curr].data[2].enable">
							<div class="form-group">
								ขนาด (ความกว้าง)
								<input type="text" id="edit-2-size" class="form-control" v-model="quotdata[curr].data[2].size">
							</div>
							<div class="form-group">
								ตำแหน่งปัก
								<input type="text" id="edit-2-position" class="form-control" v-model="quotdata[curr].data[2].position">
							</div>
							<div class="form-group">
								ไฟล์เสื้อ
								<select id="edit-2-file" class="form-control" onchange="quotdata[vm_edit.curr].data[2].file = event.target.value;" :value="quotdata[curr].data[2].file">
									<option>อ้างอิงตามลูกค้า</option>
									<option>ดราฟใหม่</option>
									<option>{{quotdata[curr].data[2].file}}</option>
								</select>
							</div>
							<div class="form-group">
								ระยะห่างจากคอเสื้อถึงตัวงาน
								<select id="edit-2-distance" class="form-control" onchange="quotdata[vm_edit.curr].data[2].distance = event.target.value;"
								 :value="quotdata[curr].data[2].distance">
									<option>ปรับตามขนาดเสื้อให้</option>
									<option>มาตราฐาน</option>
									<option value="custom_cm">... cm</option>
									<option>{{quotdata[curr].data[2].distance}}</option>
								</select>
								<template v-if="quotdata[vm_edit.curr].data[2].distance == 'custom_cm'">
									<input type="number" id="edit-2-distance-cm" class="form-control form-control-inline mt-2" v-model="quotdata[vm_edit.curr].data[2].distance_cm"> cm
								</template>
							</div>
						</span>

					</div>
					<div class="modal-footer">
						<button type="button" id="edit-submit-btn" class="btn btn-primary edit-footer-btn" onclick="edit_submit()">บันทึก</button>
						<button type="button" class="btn btn-danger edit-footer-btn" data-dismiss="modal" onclick="edit_cancel(); edit_exit();">ยกเลิก</button>
						<button type="button" class="btn btn-secondary edit-footer-btn" data-dismiss="modal" onclick="edit_exit()">ปิด (ไม่เปลี่ยนข้อมูลกลับ)</button>
						<button type="button" id="edit-unlock-btn" class="btn btn-primary edit-footer-btn" onclick="unlock_form()">ปลดล็อก</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="addmodal" class="modal" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">เลขที่ใบเสนอราคา</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<input type="text" id="add-id" class="form-control">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" onclick="doadd2()" data-dismiss="modal">Add</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				</div>
			</div>
		</div>
	</div>

	<div id="duplicatemodal" class="modal" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">ทำซ้ำ <span id="duplicate-title"></span></h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					เลขที่ใบเสนอราคา ใหม่
					<input type="text" id="duplicate-id" class="form-control">
					<input type="hidden" id="duplicate-index" class="form-control">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" onclick="doduplicate2()" data-dismiss="modal">ทำซ้ำ</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				</div>
			</div>
		</div>
	</div>

	<div id="deletemodal" class="modal" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">ต้องการลบ ?</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					ต้องการลบ
					<span id="delete-id"></span>
					<br> (
					<span id="delete-index"></span> )
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" onclick="dodelete(parseInt($('#delete-index').html()))" data-dismiss="modal">Delete</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				</div>
			</div>
		</div>
	</div>

	<script src="https://www.gstatic.com/firebasejs/4.9.0/firebase.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.9.1/firebase-firestore.js"></script>
	<script>
		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyCKxEYUtxMrevfSLSRHKUHc7gKTSKBZ-Vg",
			authDomain: "somsritshirt-ced49.firebaseapp.com",
			databaseURL: "https://somsritshirt-ced49.firebaseio.com",
			projectId: "somsritshirt-ced49",
			storageBucket: "somsritshirt-ced49.appspot.com",
			messagingSenderId: "99816736698"
		};
		firebase.initializeApp(config);

		var db = firebase.firestore();
		var storage = firebase.storage();
		var storageRef = storage.ref();

	</script>

	<script>
		//data of select
		var selectdata = {
			"type": [
				{ text: "เสื้อยืด", value: "เสื้อยืด", condition: "true" },
				{ text: "เสื้อโปโล", value: "เสื้อโปโล", condition: "true" },
			],
			"0-fabric": [
				{ text: "Cotton 100%", value: "Cotton 100%", condition: "true" },
				{ text: "cotton comb", value: "cotton comb", condition: "true" },
				{ text: "supersoff", value: "supersoff", condition: "true" },
				{ text: "TC lacos", value: "TC lacos", condition: "true" },
				{ text: "TC", value: "TC", condition: "true" },
				{ text: "TK", value: "TK", condition: "true" },
			],
			"0-size_label": [
				{text: "สมศรีมีเสื้อ", value: "สมศรีมีเสื้อ", condition: "true"},
				{text: "ป้ายไซต์อย่างเดียว", value: "ป้ายไซต์อย่างเดียว", condition: "true"},
			],
			"1-type": [
				{text: "งานพิมพ์", value: "งานพิมพ์", condition: "true"},
				{text: "สียาง", value: "สียาง", condition: "true"},
				{text: "สีพลาสติซอล", value: "สีพลาสติซอล", condition: "true"},
				{text: "สีน้ำ", value: "สีน้ำ", condition: "true"},
			],
			"0-collar": [
				{text: "คอกลม", value: "คอกลม", condition: "quotdata[curr].type.indexOf('เสื้อยืด')!=-1"},
				{text: "คอวี", value: "คอวี", condition: "quotdata[curr].type.indexOf('เสื้อยืด')!=-1"},
				{text: "ทอตามสีเสื้อ", value: "ทอตามสีเสื้อ", condition: "quotdata[curr].type.indexOf('เสื้อโปโล')!=-1"},
				{text: "ทอลายพิเศษ", value: "ทอลายพิเศษ", condition: "quotdata[curr].type.indexOf('เสื้อโปโล')!=-1"},
				{text: "ทอแจ๊คการ์ด", value: "ทอแจ๊คการ์ด", condition: "quotdata[curr].type.indexOf('เสื้อโปโล')!=-1"},
			],
			"0-placket": [
				{text: "สีเดียวกับเสื้อ", value: "สีเดียวกับเสื้อ", condition: "true"},
				{text: "สาบแลป", value: "สาบแลป", condition: "true"},
				{text: "โชว์สองสี", value: "โชว์สองสี", condition: "true"},
				{text: "สาบซ่อน", value: "สาบซ่อน", condition: "true"},
				{text: "คอวีจั้ม", value: "คอวีจั้ม", condition: "true"},
			]
		}

		function selectdata_find(selectdata_key, val) {
			return _.find(selectdata[selectdata_key], (o) => o.value == val);
		}

		function isSpecialChar(char,exclude) {
			if (!exclude) exclude = "";
			if (exclude.indexOf(char)!=-1) return false;
			var c = char.charCodeAt(0);
			if ((c>=33 && c<=47) || (c>=58 && c<=64) || (c>=91 && c<=96) || (c>=123 && c<=126)) {
				return true;
			}
			return false;
		}

		String.prototype.replaceSpecialChar = function(replaceWith,exclude) {
			var res = "";
			for(var i = 0;i<this.length;i++) {
				if(isSpecialChar(this[i],exclude)) {
					res += replaceWith;
				} else {
					res += this[i];
				}
			}
			return res;
		}

		//update db add field to all
		function updatedb_addfield(key, value) {
			db.collection("quotation").get().then(function (querySnapshot) {
				querySnapshot.forEach(function (doc) {
					var newdata = doc.data();
					newdata[key] = value;
					db.collection("quotation").doc(doc.id).set(newdata);
				});
			});
		}

		function updateQueryStringParameter(key, value) {
			var uri = window.location.href;
			var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
			var separator = uri.indexOf('?') !== -1 ? "&" : "?";
			if (uri.match(re)) {
				return uri.replace(re, '$1' + key + "=" + value + '$2');
			}
			else {
				return uri + separator + key + "=" + value;
			}
		}

		function formatdate(date, noday, nomonth) {
			if (!date) return "ไม่ได้ระบุไว้";
			date = new Date(date);
			month = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
			if (nomonth) {
				return (date.getFullYear() + 543);
			} else if (noday) {
				return month[date.getMonth()] + " " + (date.getFullYear() + 543);
			} else {
				return date.getDate() + " " + month[date.getMonth()] + " " + (date.getFullYear() + 543);
			}
		}

		function getParameterByName(name, url) {
			if (!url) url = window.location.href;
			name = name.replace(/[\[\]]/g, "\\$&");
			var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
				results = regex.exec(url);
			if (!results) return null;
			if (!results[2]) return '';
			return decodeURIComponent(results[2].replace(/\+/g, " "));
		}

		function refresh_select2() {
			setTimeout(function () {
				$("select").select2({
					tags: true,
					dropdownParent: $("#editmodal").find(".modal-content")
				});
			}, 10);
			setTimeout(function () {
				vm_edit.$forceUpdate();
			}, 20);
			setTimeout(function () {
				$("select").select2({
					tags: true,
					dropdownParent: $("#editmodal").find(".modal-content")
				});
			}, 50);
		}

		function isidduplicate(id) {
			for (data of quotdata) {
				if (id == data.id) return data;
			}
			return false;
		}

		function calculate_extra_quotdata() {
			for (var i = 0; i < quotdata.length; i++) {
				quotdata[i].i = i;
			}


			quotdata_bymonth = {};
			if (sortby == "created") {
				var monthi = 0;
				for (var i = 0; i < quotdata.length; i++) {
					var month = formatdate(quotdata[i].created, true);
					if (!quotdata_bymonth[month]) {
						quotdata_bymonth[month] = [];
						quotdata_bymonth[month].i = monthi;
						monthi++;
					}
					quotdata_bymonth[month].push(quotdata[i]);
				}
			} else if (sortby == "due") {
				var monthi = 0;
				for (var i = 0; i < quotdata.length; i++) {
					var month = formatdate(quotdata[i].due, true);
					if (!quotdata_bymonth[month]) {
						quotdata_bymonth[month] = [];
						quotdata_bymonth[month].i = monthi;
						monthi++;
					}
					quotdata_bymonth[month].push(quotdata[i]);
				}
			} else {
				quotdata_bymonth["ทั้งหมด"] = [];
				quotdata_bymonth["ทั้งหมด"].i = 0;
				for (var i = 0; i < quotdata.length; i++) {
					quotdata_bymonth["ทั้งหมด"].push(quotdata[i]);
				}
			}
			vm.$forceUpdate();
		}

		var sortby = getParameterByName("sortby") || "created";

		var quotdata = []//[{ id: "", name: "", due: null, img: "", data: [{ type: "งานตัดและเย็บ" }] }];
		var quotdata_bymonth = {}//{ "*": [{ id: "", name: "", due: null, img: "", data: [{ type: "งานตัดและเย็บ" }] }] };
		var quotbodybak = [];
		var isadmin = false;
		var auth_email,auth_uid;
		var loading = true;

		async function init_isadmin() {
			var doc = await db.collection("users").doc(auth_email).get();
			//console.log(doc);
			isadmin = doc.exists;

			vm.$forceUpdate();
		}

		async function init_selectdata() {
			let data = (await db.collection("selectdata").doc("quotation").get()).data().data;
			function merge_customizer(left, right) {
				if (_.isArray(left) && _.isArray(right)) {
					return _.unionWith(left, right, (a, b) => {
						return a.value == b.value;
					});
				}
				else if (_.isArray(left)) return left;
				else if (_.isArray(right)) return right;
				return left;
			}
			_.mergeWith(selectdata, data, merge_customizer);
		}

		async function init_quotdata() {
			var partial = db.collection("quotation").orderBy(sortby, 'desc');
			/*if (!isadmin) {
				partial = partial.where("owner","==",auth_email);
			}*/
			var querySnapshot = await partial.get()

			quotdata = [];
			querySnapshot.forEach(function (doc) {
				// doc.data() is never undefined for query doc snapshots
				//console.log(doc.id, " => ", doc.data());
				var data = doc.data();
				if (isadmin || (data.owner == auth_email)) {
					quotdata.push(data);
					quotdata[quotdata.length - 1].i = quotdata.length - 1;
				}
			});
			calculate_extra_quotdata();
			vm_edit.$forceUpdate();
		}

		function countamount(data) {
			function process(data,allamountstr) {
				function resolve(data,amountstr) {
					fraglist = amountstr.split(" ");
					//console.log(amountstr);

					for(var i = 0;i<fraglist.length;i++) {
						fraglist[i] = fraglist[i].trim();
						if (fraglist[i] == "") {
							fraglist.splice(i,1);
							i--;
						}
					}

					var amount = -1;
					var label = "";
					var ok = true;

					for(var i = fraglist.length-1;i>=0;i--) {
						if (amount==-1) {
							if (!isNaN(parseInt(fraglist[i]))) {
								amount = parseInt(fraglist[i]);
							}
						} else {
							label = fraglist[i] + " " + label;
						}
					}

					label = label.trim();

					if (label.indexOf("จำนวน") != -1 || label.indexOf("รวม") != -1 || label.indexOf("ทั้งหมด") != -1) {
						ok = false;
					}

					if (ok && amount!=-1 && label!="") {
						if(!data.amountlist[label]) data.amountlist[label] = {amount:0};
						data.amountlist[label].amount += amount;
					}
				}

				//var allamountstr = data.data[0].amount;
				allamountstr = allamountstr.replaceSpecialChar(" ","'\".");
				var amountlist = allamountstr.split("\n");
				for(amountstr of amountlist) {
					resolve(data,amountstr);
				}
			}

			//for(data of quotdata) {
				data.amountlist = {};

				process(data,data.data[0].amount);
				if (typeof data.data[0].picrow == "object") {
					for(picrow of data.data[0].picrow) {
						process(data,picrow.text);
					}
				}

				//now data.amountlist[...].amount constructed, need .order
				var currorder = 0;
				for(var key in data.amountlist) {
					data.amountlist[key].order = currorder++;
				}
			//}
		}

		async function init() {
			//init auth
			var ui = new firebaseui.auth.AuthUI(firebase.auth());
		
			ui.start('#firebaseui-auth-container', {
				signInOptions : [
					// List of OAuth providers supported.
					firebase.auth.GoogleAuthProvider.PROVIDER_ID
				]
				// Other config options...
			});
			
			firebase.auth().onAuthStateChanged(async function(user) {
				if (user) {
					var email = user.email;
					var uid = user.uid;

					auth_email = email;
					auth_uid = uid;
				
					$("#email").text(email);
					$("#uid").text(uid);
					$("#firebaseui-auth-container").hide();

					vm.$forceUpdate();

					await init_isadmin();
					await init_selectdata();
					await init_quotdata();

					//await init_countamount();

					loading = false;
					vm.$forceUpdate();
				}
			});
		}
		init();

		var vm = new Vue({
			el: '#vue-wrap',
			data: {
				quotdata: quotdata
			},
			methods: {
				doedit: function (index) {
					vm_edit.curr = index;
					$("#editmodal").modal('show');
					quotbodybak = JSON.parse(JSON.stringify(quotdata[vm_edit.curr]));
					setTimeout(function () {
						vm_edit.$forceUpdate();
						//refresh_select2();
					}, 50);
					setTimeout(function () {
						refresh_select2();
					}, 100);
					vm_edit.$forceUpdate();
				}
			},
		});

		var vm_edit = new Vue({
			el: '#vue-editmodal',
			data: {
				curr: 0
			},
			components: {
				'editor': Editor // <- Important part
			}
		});

		var vm_count = new Vue({
			el: '#vue-countmodal',
			data: {
				window: window,
				isSaved: true
			},
			components: {
				'editor': Editor // <- Important part
			}
		});

		function edit_exit() {
			$("select").select2('destroy');
		}

		function edit_cancel() {
			var curr = vm_edit.curr;
			quotdata[curr] = quotbodybak;
			vm_edit.$forceUpdate();
		}

		function doapprove(i) {
			quotdata[i].approve = !quotdata[i].approve;
			if (quotdata[i].approve) {
				quotdata[i].approved_by = auth_email;
				quotdata[i].approved_at = new Date();
			}
			db.collection("quotation").doc(quotdata[i].id).update({"approve":quotdata[i].approve,"approved_by": quotdata[i].approved_by,"approved_at": quotdata[i].approved_at}).then(function () {
				//alert("แก้ไขการอนุมัติเรียบร้อย");
			}).catch(function (err) {
				alert("Approve error : " + JSON.stringify(err));
			});
			vm.$forceUpdate();
		}

		function doshow(i) {
			window.open("/quotation/view?id=" + encodeURIComponent(quotdata[i].id), "_blank");
		}

		function docountamount(i) {
			vm_edit.curr = i;
			vm_count.isSaved = true;
			vm_count.$forceUpdate();
			setTimeout(function(){
				$('#countmodal').modal('show')
			},100);
		}

		function doadd2() {
			if (!auth_email) {
				alert("กรุณา Login ก่อน");
				return;
			}

			var id = $("#add-id").val().trim();
			if (dupdata = isidduplicate(id)) {
				alert("ID ซ้ำกัน กับใบเสนอราคาที่ถูกสร้างเมื่อ " + formatdate(dupdata.created));
				setTimeout(() => {
					vm.doedit(dupdata.i);
					vm_edit.$forceUpdate();
				}, 10);
				return;
			}
			var newdata = {
				id: id,
				name: "",
				img: [],
				imgsize: 50,
				due: new Date().toISOString().split('T')[0],
				data: [
					{
						amount: "S = \nM = \nL = \nXL = \n",
						button: 0,
						collar: "คอกลม",
						color: "",
						enable: true,
						example: "ขึ้นตัวอย่าง",
						fabric: "Cotton 100%",
						moreinfo: "",
						placket: "สีเดียวกับเสื้อ",
						pocket: "ไม่มี",
						size: 'ตามขนาดมาตรฐาน\nS-34"\nM-36"\nL-40"\nXL-44"\nXXL-48"',
						size_label: "สมศรีมีเสื้อ",
						sleeve: "แขนสั้นปล่อย",
						style: "ตามรูปแบบมาตรฐาน",
						picrow: []
					},
					{
						color: "",
						distance: "ปรับตามขนาดเสื้อให้",
						enable: false,
						file: "อ้างอิงตามลูกค้า",
						position: "",
						size: "ด้านหน้ากว้าง X นิ้ว ด้านหลังกว้าง Y นิ้ว",
						type: "งานพิมพ์"
					},
					{
						distance: "ปรับตามขนาดเสื้อให้",
						enable: false,
						file: "อ้างอิงตามลูกค้า",
						position: "",
						size: ""
					}
				],
				created: new Date(),
				created_at: new Date(),
				type: "เสื้อยืด",
				owner: auth_email,
				created_by: auth_email
			};
			db.collection("quotation").doc(id).set(newdata).then(function () {
				alert("Add Success");
				quotdata.unshift(newdata);
				vm.doedit(0);
				calculate_extra_quotdata();
			}).catch(function (err) {
				alert("Add Error : " + JSON.stringify(err));
				console.log("Add Error");
				console.log(err);
			});
		}

		function doadd() {
			$("#addmodal").modal('show');
			$("#add-id").val("");
		}

		function doduplicate2() {
			if (!auth_email) {
				alert("กรุณา Login ก่อน");
				return;
			}

			var id = $("#duplicate-id").val().trim();
			if (dupdata = isidduplicate(id)) {
				alert("ID ซ้ำกัน กับใบเสนอราคาที่ถูกสร้างเมื่อ " + formatdate(dupdata.created));
				setTimeout(() => {
					vm.doedit(dupdata.i);
					vm_edit.$forceUpdate();
				}, 10);
				return;
			}
			
			var newdata = _.cloneDeep(quotdata[parseInt($("#duplicate-index").val())]);
			newdata.id = id;
			newdata.created = new Date();
			newdata.created_at = new Date();
			newdata.created_by = auth_email;
			db.collection("quotation").doc(id).set(newdata).then(function () {
				alert("Add Success");
				quotdata.unshift(newdata);
				vm.doedit(0);
				calculate_extra_quotdata();
			}).catch(function (err) {
				alert("Add Error : " + JSON.stringify(err));
				console.log("Add Error");
				console.log(err);
			});
		}

		function doduplicate(i) {
			$("#duplicatemodal").modal('show');
			$("#duplicate-index").val(i);
			$("#duplicate-title").text(quotdata[i].id);
		}

		function dodelete2(index) {
			$("#deletemodal").modal('show');
			$("#delete-id").text(quotdata[index].id);
			$("#delete-index").text(index);
		}

		function dodelete(index) {
			db.collection("quotation").doc(quotdata[index].id).delete().then(function () {
				alert("Delete Success");
				quotdata.splice(index, 1);
				calculate_extra_quotdata();
			}).catch(function (err) {
				alert("Delete Error : " + JSON.stringify(err));
				console.log("Delete Error");
				console.log(err);
			});
		}

		function refresh_selectdata() {
			$(".editor-select").each(function () {
				var $ele = $(this);
				var val = $ele.val();
				//console.log($ele);
				var ele_id = $ele.attr("id");
				var selectdata_key = ele_id.substr(5);
				//console.log(selectdata_key);
				//console.log(selectdata_key,selectdata[selectdata_key]);
				if (selectdata[selectdata_key]) {
					//add tag if not exists
					var oldselectdata = selectdata_find(selectdata_key, val);
					if (!oldselectdata) {
						selectdata[selectdata_key].push({
							text: val,
							value: val,
							condition: (function() {
								if (selectdata_key=="0-collar") {
									if ($("#edit-type").val().indexOf('เสื้อโปโล') != -1) {
										return "quotdata[curr].type.indexOf('เสื้อโปโล')!=-1";
									} else if ($("#edit-type").val().indexOf('เสื้อยืด') != -1) {
										return "quotdata[curr].type.indexOf('เสื้อยืด')!=-1";
									} else {
										return "quotdata[curr].type.indexOf('เสื้อโปโล')==-1 && quotdata[curr].type.indexOf('เสื้อยืด')==-1";
									}
								}
								return "true";
							})()
						})
					}
				}
				setTimeout(() => {
					vm_edit.$forceUpdate();
				}, 10);
			});

			//sort it
			for(var key in selectdata) {
				_.sortBy(selectdata[key],['text']);				
			}
		}

		async function save_selectdata() {
			refresh_selectdata();
			try {
				await db.collection("selectdata").doc("quotation").set({
					id: "quotation",
					url: "https://somsritshirt.com/quotation",
					data: selectdata
				});
			} catch (err) {
				alert("Update select data Error : " + JSON.stringify(err));
				console.log("Update select data Error");
				console.log(err);
			}
		}

		async function edit_submit() {
			var curr = vm_edit.curr;
			$("#editmodal .btn, #editmodal input, #editmodal textarea").prop("disabled", true);

			var hasupdate = false;

			{ //update version
				//update: add picrow
				if (!quotdata[curr].data[0].picrow) {
					quotdata[curr].data[0].picrow = [];
					hasupdate = true; //important
				}
			}

			var imgref = storageRef.child("quotation/im");
			var fileid = Date.now();

			var filefinishcount = 0;
			var filecount = 0;

			var awimgfile = $("#edit-awimg")[0] && $("#edit-awimg")[0].files[0];

			if (awimgfile) {
				filecount++;
				uploadimg(String(fileid - 3), awimgfile).then(function (url) {
					quotdata[curr].img = url;

					filefinishcount++;
					checkfilefinish();
				}).catch(function (err) {
					alert("Artwork Image error : " + JSON.stringify(err));
					console.log("Artwork Image error");
					console.log(err);
				});
			}

			for (let i = 0; i < quotdata[curr].data[0].picrow.length; i++) {
				let picrow_file = $("#edit-0-picrow-img-" + i)[0].files[0];
				if (picrow_file) {
					filecount++;
					uploadimg(String(fileid + (i + 1)), picrow_file).then(function (url) {
						quotdata[curr].data[0].picrow[i].img = url;

						filefinishcount++;
						checkfilefinish();
					}).catch(function (err) {
						alert("Picrow " + (i + 1) + " Image error : " + JSON.stringify(err));
						console.log("Picrow " + (i + 1) + " Image error");
						console.log(err);
					});
				}
			}

			if (typeof quotdata[curr].img == "object") {
				for (let i = 0; i < quotdata[curr].img.length; i++) {
					let picrow_file = $("#edit-img-" + i)[0].files[0];
					if (picrow_file) {
						filecount++;
						uploadimg(String(fileid + (i + quotdata[curr].data[0].picrow.length + 1)), picrow_file).then(function (url) {
							quotdata[curr].img[i].img = url;

							filefinishcount++;
							checkfilefinish();
						}).catch(function (err) {
							alert("Top " + (i + 1) + " Image error : " + JSON.stringify(err));
							console.log("Top " + (i + 1) + " Image error");
							console.log(err);
						});
					}
				}
			}

			async function checkfilefinish() {
				if (filefinishcount == filecount) await dofinal();
			}
			await checkfilefinish();


			async function dofinal() {
				await save_selectdata();

				quotdata[curr].updated_at = new Date();
				quotdata[curr].updated_by = auth_email;

				db.collection("quotation").doc(quotdata[curr].id).set(quotdata[curr]).then(function () {
					alert("แก้ไขข้อมูลเรียบร้อย");
					if (hasupdate) {
						alert("อัพเดท version เรียบร้อย ระบบจะทำการ reload หน้าเว็บ");
						location.reload();
					}
					$("#editmodal .btn, #editmodal input, #editmodal textarea").prop("disabled", false);
					$("#editmodal input[type=file]").val("");
				}).catch(function (err) {
					alert("Final Step Error : " + JSON.stringify(err));
					console.log("Final Step Error");
					console.log(err);
					$("#editmodal .btn, #editmodal input, #editmodal textarea").prop("disabled", false);
					$("#editmodal input[type=file]").val("");
				});
				vm.$forceUpdate();
			}
		}

		function uploadimg(filename, imgfile) {
			return new Promise(function (resolve, reject) {
				var imgref = storageRef.child("quotation/im");

				if (imgfile.type == "image/jpeg") {
					var fileref = imgref.child(filename + ".jpg");
					fileref.put(imgfile).then(function (data) {
						//console.log(data);
						function dogeturl() {
							setTimeout(function () {
								var jpgref = imgref.child(filename + ".jpg");
								jpgref.getDownloadURL().then(resolve).catch(function (err) {
									console.log("Get url error : ", err);
									dogeturl();
								});
							}, 10/*3000*/);
						}
						dogeturl();
					}).catch(reject);
				} else if (imgfile.type == "image/png") {
					var fileref = imgref.child(filename + ".png");
					fileref.put(imgfile).then(function (data) {
						//console.log(data);
						function dogeturl() {
							setTimeout(function () {
								var jpgref = imgref.child(filename + ".png");
								jpgref.getDownloadURL().then(resolve).catch(function (err) {
									console.log("Get url error : ", err);
									dogeturl();
								});
							}, 10/*3000*/);
						}
						dogeturl();
					}).catch(reject);
				} else {
					//alert("Image Error : "+imgfile.type+" Not supported");
					reject("Image Error : " + imgfile.type + " Not supported");
				}
			});
		}

		function unlock_form() {
			$("#editmodal .btn, #editmodal input, #editmodal textarea").prop("disabled", false);
		}

		setInterval(function () {
			$("#edit-unlock-btn").prop("disabled", false);
		}, 500);
	</script>
</body>

</html>